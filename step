#include <WiFi.h>
#include <MQTT.h>
#include <Stepper.h>

// --- 1. Config ---
const char ssid[] = "YOUR_WIFI_SSID";
const char pass[] = "YOUR_WIFI_PASS";

const char mqtt_broker[] = "broker.hivemq.com";
const char mqtt_client_id[] = "esp32_stepper_exam_01";
String topic_prefix = "my_exam_user1"; // <-- เปลี่ยนชื่อตรงนี้!!!

// --- 2. Pins & Stepper Config ---
const int LDR_PIN = 34;

// การตั้งค่า Stepper (ตัวอย่างสำหรับ 28BYJ-48)
const int STEPS_PER_REV = 2048; 
// ขา Pin (IN1, IN3, IN2, IN4)
const int IN1 = 26;
const int IN2 = 27;
const int IN3 = 14;
const int IN4 = 12;

Stepper myStepper(STEPS_PER_REV, IN1, IN3, IN2, IN4);

// --- 3. Variables ---
WiFiClient net;
MQTTClient client;
unsigned long lastMillis = 0;

float currentAngle = 0.0; // เก็บค่าองศาสะสม
int ldrValueRaw = 0;      // ค่าดิบ (0-4095)
int ldrValueMapped = 0;   // ค่าแปลง (0-1023)

// --- Helper Functions ---
void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print("."); delay(1000);
  }

  Serial.print("\nMQTT Connecting...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print("."); delay(1000);
  }
  Serial.println("\nMQTT Connected!");

  // Subscribe ปุ่ม Reset องศา
  client.subscribe(topic_prefix + "/angle/reset");
}

void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);

  // ถ้ากดปุ่ม Reset Angle
  if (topic.endsWith("/angle/reset")) {
    currentAngle = 0.0;
    client.publish(topic_prefix + "/angle", String(currentAngle));
    Serial.println("Angle Reset to 0");
  }
}

void setup() {
  Serial.begin(115200);

  // Setup Stepper
  myStepper.setSpeed(10); // ความเร็ว 10 RPM
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  
  pinMode(LDR_PIN, INPUT);

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);

  connect();
}

void loop() {
  client.loop();
  if (!client.connected()) connect();

  // --- 1. อ่านค่า LDR และแปลงเป็น 0-1023 ---
  ldrValueRaw = analogRead(LDR_PIN);
  // Map ค่าจาก 0-4095 (12-bit) เป็น 0-1023 (10-bit) ตามโจทย์
  ldrValueMapped = map(ldrValueRaw, 0, 4095, 0, 1023);

  // --- 2. Logic ควบคุมมอเตอร์ ---
  // ถ้าค่า > 500 ให้หมุน
  if (ldrValueMapped > 500) {
    int stepsToMove = 32; // ขยับทีละนิดเพื่อให้ loop ทำงานต่อได้ (Non-blocking feel)
    myStepper.step(stepsToMove); // หมุนทวนเข็ม (ถ้าอยากกลับด้านให้ใส่ติดลบ)
    
    // คำนวณองศาที่เพิ่มขึ้น
    // สูตร: (จำนวนก้าวที่เดิน / จำนวนก้าวต่อรอบ) * 360
    float angleChange = (float)stepsToMove / STEPS_PER_REV * 360.0;
    currentAngle += angleChange; 
  } else {
    // ถ้า <= 500 หยุดหมุน (ตัดไฟเข้าขดลวด)
    digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
    digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
  }

  // --- 3. ส่งค่า MQTT (ทุกๆ 1 วินาที) ---
  if (millis() - lastMillis > 1000) {
    lastMillis = millis();

    // 3.1 ส่งค่า LDR
    Serial.print("LDR (Mapped): "); Serial.print(ldrValueMapped);
    Serial.print(" | Angle: "); Serial.println(currentAngle);
    
    client.publish(topic_prefix + "/ldr", String(ldrValueMapped));

    // 3.2 ส่งค่าองศาสะสม
    client.publish(topic_prefix + "/angle", String(currentAngle));
  }
}

3. การตั้งค่า MQTT Dashboard (MQTT Tiles)
ต้องสร้าง Tiles ทั้งหมด 3 อัน ตามโจทย์ข้อ 4 ดังนี้ครับ:

Tile 1: แสดงค่าแสง (Text)
Label: LDR Value

Topic: my_exam_user1/ldr (แก้ชื่อ user ให้ตรงกับโค้ด)

ผลลัพธ์: จะโชว์ค่าตัวเลขในช่วง 0-1023

Tile 2: แสดงองศาปัจจุบัน (Text)
Label: Stepper Angle

Topic: my_exam_user1/angle

ผลลัพธ์: จะโชว์ค่าองศาที่เพิ่มขึ้นเรื่อยๆ เช่น 360.5, 720.0 (ถ้าหมุนหลายรอบเลขจะเยอะขึ้นเรื่อยๆ ตามโจทย์ "ค่าสะสม")

Tile 3: ปุ่มรีเซ็ตองศา (Button)
Label: Reset Angle

Topic: my_exam_user1/angle/reset

Payload: reset (หรือใส่อะไรก็ได้ เพราะโค้ดเช็คแค่ว่ามีข้อความเข้ามา)

Icon: (รูปถังขยะ หรือรูปลูกศรวน)
